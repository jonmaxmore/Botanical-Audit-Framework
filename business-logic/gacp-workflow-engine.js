/**
 * üè≠ GACP Workflow Engine - Core Business Logic
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ workflow ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GACP Certification Process
 *
 * 8 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å:
 * 1. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Application Submission)
 * 2. ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å - 5,000 ‡∏ö‡∏≤‡∏ó (First Payment - Document Review Fee)
 * 3. ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Document Review)
 * 4. ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô (Document Approved)
 * 5. ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á - 25,000 ‡∏ö‡∏≤‡∏ó (Second Payment - Field Inspection Fee)
 * 6. ‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏° (Field Inspection - VDO Call + On-site if needed)
 * 7. ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Final Approval)
 * 8. ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Certificate Issuance)
 */

const { EventEmitter } = require('events');
const { v4: uuidv4 } = require('uuid');

// Define workflow states with Thai names for clarity
const WORKFLOW_STATES = {
  // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  DRAFT: 'draft', // ‡∏£‡πà‡∏≤‡∏á (‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à)
  SUBMITTED: 'submitted', // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß

  // 2. ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
  PAYMENT_PENDING_1: 'payment_pending_1', // ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å (5,000 ‡∏ö‡∏≤‡∏ó)
  PAYMENT_PROCESSING_1: 'payment_processing_1', // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å

  // 3. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  DOCUMENT_REVIEW: 'document_review', // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  DOCUMENT_REVISION: 'document_revision', // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  DOCUMENT_REJECTED: 'document_rejected', // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà)
  DOCUMENT_APPROVED: 'document_approved', // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô

  // 4. ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á
  PAYMENT_PENDING_2: 'payment_pending_2', // ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á (25,000 ‡∏ö‡∏≤‡∏ó)
  PAYMENT_PROCESSING_2: 'payment_processing_2', // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á

  // 5. ‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏°
  INSPECTION_SCHEDULED: 'inspection_scheduled', // ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß
  INSPECTION_VDO_CALL: 'inspection_vdo_call', // VDO Call
  INSPECTION_ON_SITE: 'inspection_on_site', // ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á
  INSPECTION_COMPLETED: 'inspection_completed', // ‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß

  // 6. ‡∏£‡∏∞‡∏¢‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  PENDING_APPROVAL: 'pending_approval', // ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  APPROVED: 'approved', // ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
  REJECTED: 'rejected', // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò

  // 7. ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
  CERTIFICATE_GENERATING: 'certificate_generating', // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
  CERTIFICATE_ISSUED: 'certificate_issued', // ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß

  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©
  CANCELLED: 'cancelled', // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  EXPIRED: 'expired', // ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  ON_HOLD: 'on_hold' // ‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
};

// Workflow steps with clear Thai descriptions
const WORKFLOW_STEPS = {
  1: {
    step: 1,
    name: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠',
    description: '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
    states: [WORKFLOW_STATES.DRAFT, WORKFLOW_STATES.SUBMITTED],
    nextStep: 2,
    requiredActions: ['submit_application']
  },
  2: {
    step: 2,
    name: '‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å (5,000 ‡∏ö‡∏≤‡∏ó)',
    description: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
    states: [WORKFLOW_STATES.PAYMENT_PENDING_1, WORKFLOW_STATES.PAYMENT_PROCESSING_1],
    nextStep: 3,
    requiredActions: ['payment_first_phase'],
    amount: 5000
  },
  3: {
    step: 3,
    name: '‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
    description: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
    states: [
      WORKFLOW_STATES.DOCUMENT_REVIEW,
      WORKFLOW_STATES.DOCUMENT_REVISION,
      WORKFLOW_STATES.DOCUMENT_REJECTED
    ],
    nextStep: [4, 2], // ‡∏´‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô ‡πÑ‡∏õ step 4, ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ step 2
    requiredActions: ['document_review_approve', 'document_review_reject'],
    maxRejections: 2
  },
  4: {
    step: 4,
    name: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô',
    description: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
    states: [WORKFLOW_STATES.DOCUMENT_APPROVED],
    nextStep: 5,
    requiredActions: ['proceed_to_payment_2']
  },
  5: {
    step: 5,
    name: '‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á (25,000 ‡∏ö‡∏≤‡∏ó)',
    description: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°',
    states: [WORKFLOW_STATES.PAYMENT_PENDING_2, WORKFLOW_STATES.PAYMENT_PROCESSING_2],
    nextStep: 6,
    requiredActions: ['payment_second_phase'],
    amount: 25000
  },
  6: {
    step: 6,
    name: '‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏° (VDO Call + ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)',
    description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ú‡πà‡∏≤‡∏ô VDO Call ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
    states: [
      WORKFLOW_STATES.INSPECTION_SCHEDULED,
      WORKFLOW_STATES.INSPECTION_VDO_CALL,
      WORKFLOW_STATES.INSPECTION_ON_SITE,
      WORKFLOW_STATES.INSPECTION_COMPLETED
    ],
    nextStep: 7,
    requiredActions: [
      'schedule_inspection',
      'conduct_vdo_call',
      'conduct_on_site_inspection',
      'complete_inspection'
    ]
  },
  7: {
    step: 7,
    name: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á',
    description: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
    states: [WORKFLOW_STATES.PENDING_APPROVAL, WORKFLOW_STATES.APPROVED, WORKFLOW_STATES.REJECTED],
    nextStep: 8,
    requiredActions: ['final_approval', 'final_rejection']
  },
  8: {
    step: 8,
    name: '‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á',
    description: '‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ',
    states: [WORKFLOW_STATES.CERTIFICATE_GENERATING, WORKFLOW_STATES.CERTIFICATE_ISSUED],
    nextStep: null, // ‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
    requiredActions: ['generate_certificate', 'issue_certificate']
  }
};

class GACPWorkflowEngine extends EventEmitter {
  constructor(database = null) {
    super();
    this.db = database;
    this.applications = new Map(); // In-memory storage if no database

    console.log('üè≠ GACP Workflow Engine initialized');
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà
   */
  async createApplication(farmerData) {
    const applicationId = uuidv4();

    const application = {
      id: applicationId,
      applicationNumber: this.generateApplicationNumber(),
      farmerId: farmerData.farmerId,
      farmerName: farmerData.name,
      farmerEmail: farmerData.email,
      farmerPhone: farmerData.phone,
      farmDetails: farmerData.farmDetails,

      // Workflow status
      currentState: WORKFLOW_STATES.DRAFT,
      currentStep: 1,

      // Payment tracking
      payments: {
        phase1: { amount: 5000, status: 'pending', paidAt: null },
        phase2: { amount: 25000, status: 'pending', paidAt: null }
      },

      // Document review tracking
      documentReview: {
        rejectionCount: 0,
        maxRejections: 2,
        reviews: []
      },

      // Inspection tracking
      inspection: {
        vdoCallScheduled: null,
        vdoCallCompleted: null,
        onSiteRequired: false,
        onSiteScheduled: null,
        onSiteCompleted: null,
        findings: []
      },

      // Approval tracking
      approval: {
        approved: false,
        approvedBy: null,
        approvedAt: null,
        rejectionReason: null
      },

      // Certificate
      certificate: {
        number: null,
        generatedAt: null,
        downloadUrl: null
      },

      // Audit trail
      history: [
        {
          action: 'APPLICATION_CREATED',
          timestamp: new Date(),
          actor: farmerData.farmerId,
          state: WORKFLOW_STATES.DRAFT,
          note: '‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô'
        }
      ],

      // Metadata
      createdAt: new Date(),
      updatedAt: new Date()
    };

    // Save to storage
    if (this.db) {
      await this.db.collection('applications').insertOne(application);
    } else {
      this.applications.set(applicationId, application);
    }

    // Emit event
    this.emit('application_created', application);

    console.log(`üìù Application created: ${applicationId} for farmer: ${farmerData.name}`);
    return application;
  }

  /**
   * ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ (Step 1 -> Step 2)
   */
  async submitApplication(applicationId, documents) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.DRAFT) {
      throw new Error('‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
    }

    // Validate required documents
    if (!this.validateRequiredDocuments(documents)) {
      throw new Error('‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    }

    // Update state
    application.currentState = WORKFLOW_STATES.SUBMITTED;
    application.documents = documents;
    application.submittedAt = new Date();
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'APPLICATION_SUBMITTED',
      timestamp: new Date(),
      actor: application.farmerId,
      state: WORKFLOW_STATES.SUBMITTED,
      note: '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß - ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å'
    });

    await this.saveApplication(application);

    // Auto-transition to payment phase 1
    await this.requestFirstPayment(applicationId);

    this.emit('application_submitted', application);
    console.log(`üì§ Application submitted: ${applicationId}`);

    return application;
  }

  /**
   * ‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å (Step 2)
   */
  async requestFirstPayment(applicationId) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.SUBMITTED) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å');
    }

    // Update state
    application.currentState = WORKFLOW_STATES.PAYMENT_PENDING_1;
    application.currentStep = 2;
    application.payments.phase1.status = 'pending';
    application.payments.phase1.requestedAt = new Date();
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'PAYMENT_1_REQUESTED',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.PAYMENT_PENDING_1,
      note: '‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å 5,000 ‡∏ö‡∏≤‡∏ó'
    });

    await this.saveApplication(application);

    this.emit('payment_requested', {
      application,
      phase: 1,
      amount: 5000,
      description: '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'
    });

    console.log(`üí∞ First payment requested: ${applicationId} - 5,000 THB`);
    return application;
  }

  /**
   * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
   */
  async recordFirstPayment(applicationId, paymentData) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.PAYMENT_PENDING_1) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
    }

    // Update payment status
    application.currentState = WORKFLOW_STATES.PAYMENT_PROCESSING_1;
    application.payments.phase1.status = 'processing';
    application.payments.phase1.transactionId = paymentData.transactionId;
    application.payments.phase1.paidAt = new Date();
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'PAYMENT_1_PROCESSING',
      timestamp: new Date(),
      actor: application.farmerId,
      state: WORKFLOW_STATES.PAYMENT_PROCESSING_1,
      note: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
      details: { transactionId: paymentData.transactionId }
    });

    await this.saveApplication(application);

    // Auto-confirm payment (in real system, this would be async)
    await this.confirmFirstPayment(applicationId);

    return application;
  }

  /**
   * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
   */
  async confirmFirstPayment(applicationId) {
    const application = await this.getApplication(applicationId);

    // Update payment and start document review
    application.currentState = WORKFLOW_STATES.DOCUMENT_REVIEW;
    application.currentStep = 3;
    application.payments.phase1.status = 'completed';
    application.payments.phase1.confirmedAt = new Date();
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'PAYMENT_1_CONFIRMED',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.DOCUMENT_REVIEW,
      note: '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'
    });

    await this.saveApplication(application);

    this.emit('payment_confirmed', {
      application,
      phase: 1,
      amount: 5000
    });

    console.log(`‚úÖ First payment confirmed: ${applicationId} - Starting document review`);
    return application;
  }

  /**
   * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Step 3)
   */
  async reviewDocuments(applicationId, reviewerId, reviewResult) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.DOCUMENT_REVIEW) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
    }

    const { approved, findings, corrections } = reviewResult;

    // Create review record
    const review = {
      reviewerId,
      reviewedAt: new Date(),
      approved,
      findings,
      corrections
    };

    application.documentReview.reviews.push(review);
    application.updatedAt = new Date();

    if (approved) {
      // Document approved - proceed to next step
      application.currentState = WORKFLOW_STATES.DOCUMENT_APPROVED;
      application.currentStep = 4;

      application.history.push({
        action: 'DOCUMENT_APPROVED',
        timestamp: new Date(),
        actor: reviewerId,
        state: WORKFLOW_STATES.DOCUMENT_APPROVED,
        note: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö - ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á'
      });

      // Auto-request second payment
      await this.saveApplication(application);
      await this.requestSecondPayment(applicationId);
    } else {
      // Document rejected
      application.documentReview.rejectionCount++;

      if (application.documentReview.rejectionCount >= application.documentReview.maxRejections) {
        // Too many rejections - require new payment
        application.currentState = WORKFLOW_STATES.DOCUMENT_REJECTED;
        application.currentStep = 2; // Go back to payment step
        application.payments.phase1.status = 'expired'; // Mark previous payment as expired

        application.history.push({
          action: 'DOCUMENT_REJECTED_MAX',
          timestamp: new Date(),
          actor: reviewerId,
          state: WORKFLOW_STATES.DOCUMENT_REJECTED,
          note: `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏£‡∏ö ${application.documentReview.maxRejections} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á - ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà`
        });
      } else {
        // Allow correction
        application.currentState = WORKFLOW_STATES.DOCUMENT_REVISION;

        application.history.push({
          action: 'DOCUMENT_REVISION_REQUIRED',
          timestamp: new Date(),
          actor: reviewerId,
          state: WORKFLOW_STATES.DOCUMENT_REVISION,
          note: `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${application.documentReview.rejectionCount}/${application.documentReview.maxRejections})`
        });
      }
    }

    await this.saveApplication(application);

    this.emit('document_reviewed', {
      application,
      approved,
      rejectionCount: application.documentReview.rejectionCount
    });

    console.log(`üìã Document reviewed: ${applicationId} - ${approved ? 'APPROVED' : 'REJECTED'}`);
    return application;
  }

  /**
   * ‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á (Step 5)
   */
  async requestSecondPayment(applicationId) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.DOCUMENT_APPROVED) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á');
    }

    // Update state
    application.currentState = WORKFLOW_STATES.PAYMENT_PENDING_2;
    application.currentStep = 5;
    application.payments.phase2.status = 'pending';
    application.payments.phase2.requestedAt = new Date();
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'PAYMENT_2_REQUESTED',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.PAYMENT_PENDING_2,
      note: '‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á 25,000 ‡∏ö‡∏≤‡∏ó'
    });

    await this.saveApplication(application);

    this.emit('payment_requested', {
      application,
      phase: 2,
      amount: 25000,
      description: '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°'
    });

    console.log(`üí∞ Second payment requested: ${applicationId} - 25,000 THB`);
    return application;
  }

  /**
   * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á
   */
  async recordSecondPayment(applicationId, paymentData) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.PAYMENT_PENDING_2) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á');
    }

    // Update payment and start inspection
    application.currentState = WORKFLOW_STATES.INSPECTION_SCHEDULED;
    application.currentStep = 6;
    application.payments.phase2.status = 'completed';
    application.payments.phase2.transactionId = paymentData.transactionId;
    application.payments.phase2.paidAt = new Date();
    application.payments.phase2.confirmedAt = new Date();
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'PAYMENT_2_CONFIRMED',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.INSPECTION_SCHEDULED,
      note: '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏°'
    });

    await this.saveApplication(application);

    this.emit('payment_confirmed', {
      application,
      phase: 2,
      amount: 25000
    });

    console.log(`‚úÖ Second payment confirmed: ${applicationId} - Ready for inspection`);
    return application;
  }

  /**
   * ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ VDO Call (Step 6)
   */
  async scheduleVDOCall(applicationId, inspectorId, scheduledDateTime) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.INSPECTION_SCHEDULED) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ VDO Call');
    }

    // Update inspection details
    application.currentState = WORKFLOW_STATES.INSPECTION_VDO_CALL;
    application.inspection.vdoCallScheduled = scheduledDateTime;
    application.inspection.inspectorId = inspectorId;
    application.updatedAt = new Date();

    // Add to history
    application.history.push({
      action: 'VDO_CALL_SCHEDULED',
      timestamp: new Date(),
      actor: inspectorId,
      state: WORKFLOW_STATES.INSPECTION_VDO_CALL,
      note: `‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ VDO Call ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${scheduledDateTime.toLocaleDateString('th-TH')}`
    });

    await this.saveApplication(application);

    this.emit('vdo_call_scheduled', {
      application,
      inspector: inspectorId,
      scheduledDateTime
    });

    console.log(`üìπ VDO Call scheduled: ${applicationId} at ${scheduledDateTime}`);
    return application;
  }

  /**
   * ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ VDO Call ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   */
  async conductVDOCall(applicationId, vdoResult) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.INSPECTION_VDO_CALL) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ VDO Call');
    }

    const { inspectorId, findings, onSiteRequired, completed } = vdoResult;

    // Update inspection
    application.inspection.vdoCallCompleted = new Date();
    application.inspection.onSiteRequired = onSiteRequired;
    application.inspection.findings.push({
      type: 'VDO_CALL',
      inspectorId,
      completedAt: new Date(),
      findings,
      onSiteRequired
    });

    if (onSiteRequired) {
      // Need on-site inspection
      application.currentState = WORKFLOW_STATES.INSPECTION_ON_SITE;

      application.history.push({
        action: 'VDO_CALL_COMPLETED_ONSITE_REQUIRED',
        timestamp: new Date(),
        actor: inspectorId,
        state: WORKFLOW_STATES.INSPECTION_ON_SITE,
        note: 'VDO Call ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'
      });
    } else if (completed) {
      // VDO Call sufficient
      application.currentState = WORKFLOW_STATES.INSPECTION_COMPLETED;

      application.history.push({
        action: 'INSPECTION_COMPLETED_VDO_ONLY',
        timestamp: new Date(),
        actor: inspectorId,
        state: WORKFLOW_STATES.INSPECTION_COMPLETED,
        note: '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ VDO Call'
      });

      // Auto-proceed to approval phase
      await this.saveApplication(application);
      await this.requestFinalApproval(applicationId);
      return application;
    }

    application.updatedAt = new Date();
    await this.saveApplication(application);

    this.emit('vdo_call_completed', {
      application,
      onSiteRequired,
      findings
    });

    console.log(`üìπ VDO Call completed: ${applicationId} - On-site required: ${onSiteRequired}`);
    return application;
  }

  /**
   * ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á
   */
  async scheduleOnSiteInspection(applicationId, inspectorId, scheduledDateTime) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.INSPECTION_ON_SITE) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
    }

    application.inspection.onSiteScheduled = scheduledDateTime;
    application.updatedAt = new Date();

    application.history.push({
      action: 'ON_SITE_INSPECTION_SCHEDULED',
      timestamp: new Date(),
      actor: inspectorId,
      state: WORKFLOW_STATES.INSPECTION_ON_SITE,
      note: `‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${scheduledDateTime.toLocaleDateString('th-TH')}`
    });

    await this.saveApplication(application);

    this.emit('on_site_inspection_scheduled', {
      application,
      inspector: inspectorId,
      scheduledDateTime
    });

    console.log(`üöó On-site inspection scheduled: ${applicationId} at ${scheduledDateTime}`);
    return application;
  }

  /**
   * ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
   */
  async completeOnSiteInspection(applicationId, inspectionResult) {
    const application = await this.getApplication(applicationId);

    const { inspectorId, findings, complianceScore, photos, passed } = inspectionResult;

    // Update inspection
    application.currentState = WORKFLOW_STATES.INSPECTION_COMPLETED;
    application.inspection.onSiteCompleted = new Date();
    application.inspection.findings.push({
      type: 'ON_SITE',
      inspectorId,
      completedAt: new Date(),
      findings,
      complianceScore,
      photos,
      passed
    });

    application.history.push({
      action: 'ON_SITE_INSPECTION_COMPLETED',
      timestamp: new Date(),
      actor: inspectorId,
      state: WORKFLOW_STATES.INSPECTION_COMPLETED,
      note: `‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${complianceScore}%`
    });

    application.updatedAt = new Date();
    await this.saveApplication(application);

    // Auto-proceed to approval
    await this.requestFinalApproval(applicationId);

    this.emit('on_site_inspection_completed', {
      application,
      complianceScore,
      passed
    });

    console.log(`üöó On-site inspection completed: ${applicationId} - Score: ${complianceScore}%`);
    return application;
  }

  /**
   * ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ (Step 7)
   */
  async requestFinalApproval(applicationId) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.INSPECTION_COMPLETED) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
    }

    application.currentState = WORKFLOW_STATES.PENDING_APPROVAL;
    application.currentStep = 7;
    application.updatedAt = new Date();

    application.history.push({
      action: 'APPROVAL_REQUESTED',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.PENDING_APPROVAL,
      note: '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤'
    });

    await this.saveApplication(application);

    this.emit('approval_requested', { application });

    console.log(`üìã Final approval requested: ${applicationId}`);
    return application;
  }

  /**
   * ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Step 7)
   */
  async finalApproval(applicationId, approverId, decision) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.PENDING_APPROVAL) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
    }

    const { approved, reason } = decision;

    application.approval.approved = approved;
    application.approval.approvedBy = approverId;
    application.approval.approvedAt = new Date();
    application.updatedAt = new Date();

    if (approved) {
      // Approved - generate certificate
      application.currentState = WORKFLOW_STATES.APPROVED;
      application.currentStep = 8;

      application.history.push({
        action: 'FINAL_APPROVAL_GRANTED',
        timestamp: new Date(),
        actor: approverId,
        state: WORKFLOW_STATES.APPROVED,
        note: '‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ - ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á'
      });

      // Auto-generate certificate
      await this.saveApplication(application);
      await this.generateCertificate(applicationId);
    } else {
      // Rejected
      application.currentState = WORKFLOW_STATES.REJECTED;
      application.approval.rejectionReason = reason;

      application.history.push({
        action: 'FINAL_APPROVAL_REJECTED',
        timestamp: new Date(),
        actor: approverId,
        state: WORKFLOW_STATES.REJECTED,
        note: `‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ${reason}`
      });
    }

    await this.saveApplication(application);

    this.emit('final_approval_decided', {
      application,
      approved,
      reason
    });

    console.log(`‚úÖ Final approval: ${applicationId} - ${approved ? 'APPROVED' : 'REJECTED'}`);
    return application;
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Step 8)
   */
  async generateCertificate(applicationId) {
    const application = await this.getApplication(applicationId);

    if (application.currentState !== WORKFLOW_STATES.APPROVED) {
      throw new Error('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á');
    }

    application.currentState = WORKFLOW_STATES.CERTIFICATE_GENERATING;

    // Generate certificate number
    const certificateNumber = this.generateCertificateNumber();

    application.certificate.number = certificateNumber;
    application.certificate.generatedAt = new Date();

    // Simulate certificate generation process
    application.history.push({
      action: 'CERTIFICATE_GENERATING',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.CERTIFICATE_GENERATING,
      note: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ${certificateNumber}`
    });

    await this.saveApplication(application);

    // Simulate async certificate generation
    setTimeout(async() => {
      await this.issueCertificate(applicationId);
    }, 2000); // 2 second delay

    console.log(`üìú Certificate generation started: ${applicationId} - ${certificateNumber}`);
    return application;
  }

  /**
   * ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Step 8 - Final)
   */
  async issueCertificate(applicationId) {
    const application = await this.getApplication(applicationId);

    // Finalize certificate
    application.currentState = WORKFLOW_STATES.CERTIFICATE_ISSUED;
    application.certificate.downloadUrl = `/certificates/${application.certificate.number}.pdf`;
    application.updatedAt = new Date();

    application.history.push({
      action: 'CERTIFICATE_ISSUED',
      timestamp: new Date(),
      actor: 'SYSTEM',
      state: WORKFLOW_STATES.CERTIFICATE_ISSUED,
      note: `‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß - ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ${application.certificate.number}`
    });

    await this.saveApplication(application);

    this.emit('certificate_issued', {
      application,
      certificateNumber: application.certificate.number,
      downloadUrl: application.certificate.downloadUrl
    });

    console.log(`üéâ Certificate issued: ${applicationId} - ${application.certificate.number}`);
    return application;
  }

  // ==================== Helper Methods ====================

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
   */
  async getApplication(applicationId) {
    let application;

    if (this.db) {
      application = await this.db.collection('applications').findOne({ id: applicationId });
    } else {
      application = this.applications.get(applicationId);
    }

    if (!application) {
      throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${applicationId}`);
    }

    return application;
  }

  /**
   * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
   */
  async saveApplication(application) {
    if (this.db) {
      await this.db.collection('applications').replaceOne({ id: application.id }, application);
    } else {
      this.applications.set(application.id, application);
    }
  }

  /**
   * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
   */
  validateRequiredDocuments(documents) {
    const required = [
      'id_card',
      'house_registration',
      'land_deed',
      'farm_map',
      'water_source_permit'
    ];

    return required.every(doc => documents && documents[doc]);
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
   */
  generateApplicationNumber() {
    const year = new Date().getFullYear() + 543; // Buddhist year
    const month = String(new Date().getMonth() + 1).padStart(2, '0');
    const random = Math.floor(Math.random() * 9999)
      .toString()
      .padStart(4, '0');
    return `GACP${year}${month}${random}`;
  }

  /**
   * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
   */
  generateCertificateNumber() {
    const year = new Date().getFullYear() + 543; // Buddhist year
    const month = String(new Date().getMonth() + 1).padStart(2, '0');
    const day = String(new Date().getDate()).padStart(2, '0');
    const random = Math.floor(Math.random() * 999)
      .toString()
      .padStart(3, '0');
    return `CERT-GACP-${year}${month}${day}-${random}`;
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
   */
  async getStatistics() {
    let applications;

    if (this.db) {
      applications = await this.db.collection('applications').find({}).toArray();
    } else {
      applications = Array.from(this.applications.values());
    }

    const stats = {
      total: applications.length,
      byState: {},
      byStep: {},
      payments: {
        phase1: { completed: 0, pending: 0, total: 0 },
        phase2: { completed: 0, pending: 0, total: 0 }
      },
      certificatesIssued: 0
    };

    applications.forEach(app => {
      // Count by state
      stats.byState[app.currentState] = (stats.byState[app.currentState] || 0) + 1;

      // Count by step
      stats.byStep[app.currentStep] = (stats.byStep[app.currentStep] || 0) + 1;

      // Payment stats
      if (app.payments.phase1.status === 'completed') stats.payments.phase1.completed++;
      if (app.payments.phase1.status === 'pending') stats.payments.phase1.pending++;
      stats.payments.phase1.total += app.payments.phase1.amount || 0;

      if (app.payments.phase2.status === 'completed') stats.payments.phase2.completed++;
      if (app.payments.phase2.status === 'pending') stats.payments.phase2.pending++;
      stats.payments.phase2.total += app.payments.phase2.amount || 0;

      // Certificates
      if (app.currentState === WORKFLOW_STATES.CERTIFICATE_ISSUED) {
        stats.certificatesIssued++;
      }
    });

    return stats;
  }

  /**
   * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
   */
  async getApplicationsByState(state, limit = 10, skip = 0) {
    let applications;

    if (this.db) {
      applications = await this.db
        .collection('applications')
        .find({ currentState: state })
        .sort({ updatedAt: -1 })
        .skip(skip)
        .limit(limit)
        .toArray();
    } else {
      applications = Array.from(this.applications.values())
        .filter(app => app.currentState === state)
        .sort((a, b) => b.updatedAt - a.updatedAt)
        .slice(skip, skip + limit);
    }

    return applications;
  }
}

// Export constants and class
module.exports = {
  GACPWorkflowEngine,
  WORKFLOW_STATES,
  WORKFLOW_STEPS
};
