version: '3.8'

# ============================================================================
# GACP Platform - Sprint 1 Infrastructure
# ============================================================================
# Services: MongoDB + Redis (Session Store)
# Updated: October 15, 2025
# For: Sprint 1 - Foundation & Quick Wins
# ============================================================================

services:
  # ==========================================================================
  # INFRASTRUCTURE SERVICES
  # ==========================================================================

  # MongoDB - Primary Database
  mongo:
    image: mongo:7.0
    container_name: gacp_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: secure_password_123
      MONGO_INITDB_DATABASE: gacp_production
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    ports:
      - '27017:27017'
    networks:
      - gacp_network
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Redis - Session Store & Caching (NEW for Sprint 1)
  redis:
    image: redis:7.2-alpine
    container_name: gacp_redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass redis_password_123
      --appendonly yes
      --appendfilename "redis-aof.aof"
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    networks:
      - gacp_network
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ==========================================================================
# NETWORKS
# ==========================================================================

networks:
  gacp_network:
    driver: bridge
    name: gacp-service-network

# ==========================================================================
# VOLUMES
# ==========================================================================

volumes:
  mongodb_data:
    driver: local
    name: gacp_mongodb_data
  redis_data:
    driver: local
    name: gacp_redis_data
