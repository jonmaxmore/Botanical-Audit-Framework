# üéØ Load Testing Configuration
# ‡∏à‡∏≥‡∏•‡∏≠‡∏á 1,000 ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/‡∏ß‡∏±‡∏ô, 50 ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå 09:00-17:00 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏õ‡∏µ

config:
  target: "http://localhost:3000"
  phases:
    # Phase 1: Morning Rush (09:00-10:00) - 40% of daily users
    - duration: 3600
      arrivalRate: 7  # ~400 users/hour (1000 * 0.4 / 1 hour)
      name: "Morning Rush Hour"
    
    # Phase 2: Normal Load (10:00-12:00) - 20% of daily users  
    - duration: 7200
      arrivalRate: 1.4  # ~200 users/2 hours
      name: "Mid Morning"
    
    # Phase 3: Lunch Break (12:00-13:00) - 10% of daily users
    - duration: 3600
      arrivalRate: 1.7  # ~100 users/hour
      name: "Lunch Break"
    
    # Phase 4: Afternoon (13:00-16:00) - 20% of daily users
    - duration: 10800
      arrivalRate: 1.1  # ~200 users/3 hours
      name: "Afternoon"
    
    # Phase 5: Evening Rush (16:00-17:00) - 10% of daily users
    - duration: 3600
      arrivalRate: 1.7  # ~100 users/hour
      name: "Evening Rush"
  
  # Performance thresholds
  ensure:
    maxErrorRate: 1  # Max 1% error rate
    p95: 2000  # 95% of requests < 2 seconds
    p99: 5000  # 99% of requests < 5 seconds

  # Plugins
  plugins:
    expect: {}
    metrics-by-endpoint:
      stripQueryString: true
    statsd:
      host: localhost
      port: 8125
      prefix: "gacp.loadtest"

# Common variables
variables:
  farmer_emails:
    - "farmer1@example.com"
    - "farmer2@example.com"
    - "farmer3@example.com"
    - "farmer4@example.com"
    - "farmer5@example.com"
  
  officer_emails:
    - "officer1@dtam.go.th"
    - "officer2@dtam.go.th"
    - "officer3@dtam.go.th"
    - "officer4@dtam.go.th"
    - "officer5@dtam.go.th"
  
  inspector_emails:
    - "inspector1@dtam.go.th"
    - "inspector2@dtam.go.th"
    - "inspector3@dtam.go.th"

  provinces:
    - "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"
    - "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"
    - "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô"
    - "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï"
    - "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤"

  crop_types:
    - "‡∏Å‡∏±‡∏ç‡∏ä‡∏≤"
    - "‡∏Å‡∏±‡∏ç‡∏ä‡∏á"
    - "‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£"

# Scenarios weighted by realistic usage patterns
scenarios:
  # Farmer scenarios (70% of traffic)
  - name: "Farmer Registration"
    weight: 5
    flow:
      - post:
          url: "/api/auth/farmer/register"
          json:
            email: "farmer_{{ $randomNumber() }}@example.com"
            password: "Test@1234"
            name: "‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ {{ $randomString() }}"
            phone: "08{{ $randomNumber(10000000, 99999999) }}"
            farmName: "‡∏ü‡∏≤‡∏£‡πå‡∏°{{ $randomString() }}"
            province: "{{ provinces[$randomNumber(0, 4)] }}"
          capture:
            - json: "$.token"
              as: "token"
          expect:
            - statusCode: 201
            - contentType: json
            - hasProperty: "token"

  - name: "Farmer Login"
    weight: 20
    flow:
      - post:
          url: "/api/auth/farmer/login"
          json:
            email: "{{ farmer_emails[$randomNumber(0, 4)] }}"
            password: "Test@1234"
          capture:
            - json: "$.token"
              as: "token"
          expect:
            - statusCode: 200

  - name: "Create Application"
    weight: 15
    flow:
      - post:
          url: "/api/auth/farmer/login"
          json:
            email: "{{ farmer_emails[$randomNumber(0, 4)] }}"
            password: "Test@1234"
          capture:
            - json: "$.token"
              as: "token"
      - post:
          url: "/api/applications"
          headers:
            Authorization: "Bearer {{ token }}"
          json:
            applicantType: "individual"
            farmInformation:
              farmName: "‡∏ü‡∏≤‡∏£‡πå‡∏°{{ $randomString() }}"
              farmSize: "{{ $randomNumber(1, 50) }}"
              location:
                province: "{{ provinces[$randomNumber(0, 4)] }}"
                district: "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö"
                subdistrict: "‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö"
              crops:
                - cropType: "{{ crop_types[$randomNumber(0, 2)] }}"
                  plantingArea: "{{ $randomNumber(1, 20) }}"
          expect:
            - statusCode: [200, 201]

  - name: "View Applications"
    weight: 15
    flow:
      - post:
          url: "/api/auth/farmer/login"
          json:
            email: "{{ farmer_emails[$randomNumber(0, 4)] }}"
            password: "Test@1234"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/applications"
          headers:
            Authorization: "Bearer {{ token }}"
          expect:
            - statusCode: 200

  - name: "View Dashboard"
    weight: 10
    flow:
      - post:
          url: "/api/auth/farmer/login"
          json:
            email: "{{ farmer_emails[$randomNumber(0, 4)] }}"
            password: "Test@1234"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/dashboard/farmer"
          headers:
            Authorization: "Bearer {{ token }}"
          expect:
            - statusCode: 200

  - name: "Upload Document"
    weight: 5
    flow:
      - post:
          url: "/api/auth/farmer/login"
          json:
            email: "{{ farmer_emails[$randomNumber(0, 4)] }}"
            password: "Test@1234"
          capture:
            - json: "$.token"
              as: "token"
      - post:
          url: "/api/applications/{{ $randomString() }}/documents"
          headers:
            Authorization: "Bearer {{ token }}"
          formData:
            documentType: "LAND_OWNERSHIP"
            file: "@./test-data/sample-document.pdf"
          expect:
            - statusCode: [200, 201, 404]  # 404 if app not found is OK

  # Officer scenarios (20% of traffic)
  - name: "Officer Login & Review"
    weight: 10
    flow:
      - post:
          url: "/api/auth/dtam/login"
          json:
            email: "{{ officer_emails[$randomNumber(0, 4)] }}"
            password: "Officer@123"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/applications?status=SUBMITTED"
          headers:
            Authorization: "Bearer {{ token }}"
          expect:
            - statusCode: 200

  - name: "Officer Dashboard"
    weight: 5
    flow:
      - post:
          url: "/api/auth/dtam/login"
          json:
            email: "{{ officer_emails[$randomNumber(0, 4)] }}"
            password: "Officer@123"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/dashboard/officer"
          headers:
            Authorization: "Bearer {{ token }}"
          expect:
            - statusCode: 200

  - name: "Review Application"
    weight: 5
    flow:
      - post:
          url: "/api/auth/dtam/login"
          json:
            email: "{{ officer_emails[$randomNumber(0, 4)] }}"
            password: "Officer@123"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/applications?status=SUBMITTED&limit=1"
          headers:
            Authorization: "Bearer {{ token }}"
          capture:
            - json: "$.data[0]._id"
              as: "appId"
      - post:
          url: "/api/applications/{{ appId }}/review"
          headers:
            Authorization: "Bearer {{ token }}"
          json:
            completenessScore: "{{ $randomNumber(3, 5) }}"
            accuracyScore: "{{ $randomNumber(3, 5) }}"
            comments: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"
            decision: "APPROVED"
          expect:
            - statusCode: [200, 404]

  # Inspector scenarios (10% of traffic)
  - name: "Inspector Schedule"
    weight: 5
    flow:
      - post:
          url: "/api/auth/dtam/login"
          json:
            email: "{{ inspector_emails[$randomNumber(0, 2)] }}"
            password: "Inspector@123"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/calendar/events"
          headers:
            Authorization: "Bearer {{ token }}"
          expect:
            - statusCode: 200

  - name: "Inspector Dashboard"
    weight: 3
    flow:
      - post:
          url: "/api/auth/dtam/login"
          json:
            email: "{{ inspector_emails[$randomNumber(0, 2)] }}"
            password: "Inspector@123"
          capture:
            - json: "$.token"
              as: "token"
      - get:
          url: "/api/dashboard/inspector"
          headers:
            Authorization: "Bearer {{ token }}"
          expect:
            - statusCode: 200

  - name: "Complete Inspection"
    weight: 2
    flow:
      - post:
          url: "/api/auth/dtam/login"
          json:
            email: "{{ inspector_emails[$randomNumber(0, 2)] }}"
            password: "Inspector@123"
          capture:
            - json: "$.token"
              as: "token"
      - post:
          url: "/api/inspections/{{ $randomString() }}/complete"
          headers:
            Authorization: "Bearer {{ token }}"
          json:
            result: "PASS"
            score: "{{ $randomNumber(80, 100) }}"
            notes: "‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
          expect:
            - statusCode: [200, 404]

  # Public scenarios (anonymous)
  - name: "Verify Certificate"
    weight: 3
    flow:
      - get:
          url: "/api/certificates/verify/GACP-2025-BKK-0001"
          expect:
            - statusCode: [200, 404]

  - name: "View Public Info"
    weight: 2
    flow:
      - get:
          url: "/api/public/info"
          expect:
            - statusCode: 200
