#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running Pre-Push Production Quality Gate"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Step 1: Lint with production rules (backend only for now)
echo "ğŸ§© Linting backend (production mode)..."
cd apps/backend && cross-env NODE_ENV=production npx eslint . --ext .js,.ts
if [ $? -ne 0 ]; then
  echo "âŒ Lint failed. Fix issues before pushing."
  exit 1
fi
cd ../..

# Step 2: TypeScript build check
if [ -f "apps/backend/tsconfig.json" ]; then
  echo "ğŸ§± Type checking backend..."
  cd apps/backend && npx tsc --noEmit
  if [ $? -ne 0 ]; then
    echo "âŒ Type check failed."
    exit 1
  fi
  cd ../..
fi

# Step 3: Run full test suite
echo "ğŸ§ª Running test suite..."
npm test -- --bail --detectOpenHandles
if [ $? -ne 0 ]; then
  echo "âŒ Some tests failed. Fix before pushing."
  exit 1
fi

echo "âœ… All pre-push checks passed successfully!"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
